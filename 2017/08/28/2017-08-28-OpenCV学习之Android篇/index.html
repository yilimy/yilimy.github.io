<!doctype html>



  

<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />

<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>


  <meta name="keywords" content="android,OpenCV," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="基于Android Studio的OpenCV集成">
<meta name="keywords" content="android,OpenCV">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenCV学习之Android篇">
<meta property="og:url" content="http://yoursite.com/2017/08/28/2017-08-28-OpenCV学习之Android篇/index.html">
<meta property="og:site_name" content="眷顾の幻想乡">
<meta property="og:description" content="基于Android Studio的OpenCV集成">
<meta property="og:image" content="http://img.hb.aicdn.com/2318e801a05adb63d886c195728aa275dc40ef4ccbf5a-zj2O5T">
<meta property="og:image" content="http://img.hb.aicdn.com/756dc9319daa2f35baacecf53decf57aa82c8a95b7d9d-3QwzZ3">
<meta property="og:image" content="http://img.hb.aicdn.com/1d902219e4c6bfc5ce5fc315747ce195dcbfe4171e73a-Zyvm9M">
<meta property="og:image" content="http://img.hb.aicdn.com/ebfc4b47daaa18b27ef5104bb67f5e2864df2c541f828-YR4xae">
<meta property="og:image" content="http://img.blog.csdn.net/20151030233725171">
<meta property="og:image" content="http://img.blog.csdn.net/20151030233737754">
<meta property="og:image" content="http://img.blog.csdn.net/20151030233751041">
<meta property="og:image" content="http://img.blog.csdn.net/20151030233810853">
<meta property="og:updated_time" content="2018-02-02T12:17:55.492Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenCV学习之Android篇">
<meta name="twitter:description" content="基于Android Studio的OpenCV集成">
<meta name="twitter:image" content="http://img.hb.aicdn.com/2318e801a05adb63d886c195728aa275dc40ef4ccbf5a-zj2O5T">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/08/28/2017-08-28-OpenCV学习之Android篇/"/>





  <title>OpenCV学习之Android篇 | 眷顾の幻想乡</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5cbebc032aecfdda47d379bb5a9fb19e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">眷顾の幻想乡</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            小窝
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-clipboard"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            银河尽头
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/28/2017-08-28-OpenCV学习之Android篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Orice.Y.L.M">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="眷顾の幻想乡">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">OpenCV学习之Android篇</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-28T21:15:15+08:00">
                2017-08-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/08/28/2017-08-28-OpenCV学习之Android篇/" class="leancloud_visitors" data-flag-title="OpenCV学习之Android篇">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          
              <div class="post-description">
                  基于Android Studio的OpenCV集成
              </div>
          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="下载sdk">下载SDK</h4>
<p>本篇以Android Studio为基础，并默认已安装好NDK环境</p>
<p>参考：<br>
CSDN©_区长：<br>
<a href="http://blog.csdn.net/sbsujjbcy/article/details/49520791" target="_blank" rel="external">http://blog.csdn.net/sbsujjbcy/article/details/49520791</a><br>
博客园©小小情意：<br>
<a href="http://www.cnblogs.com/xiaoxiaoqingyi/p/6676096.html" target="_blank" rel="external">http://www.cnblogs.com/xiaoxiaoqingyi/p/6676096.html</a><br>
注： 不需要安装cygwin</p>
<p><a href="http://opencv.org" target="_blank" rel="external">OpenCV for Android</a></p>
<p><img src="http://img.hb.aicdn.com/2318e801a05adb63d886c195728aa275dc40ef4ccbf5a-zj2O5T" alt=""><br>
关于资源下载入口并不显而易见，我们把网页往下拉：
<img src="http://img.hb.aicdn.com/756dc9319daa2f35baacecf53decf57aa82c8a95b7d9d-3QwzZ3" alt=""><br>
资源是保存在sourceforge上的，然而在sourceforge上找资源也不是立马的事
sourceforge首页默认的是最新版本，由于对OpenCV目前并不太熟悉，我选择2.4版本的<br>
那么继续
<img src="http://img.hb.aicdn.com/1d902219e4c6bfc5ce5fc315747ce195dcbfe4171e73a-Zyvm9M" alt="">
然后可以选择需要的版本了，我选择2.4.13版本
<img src="http://img.hb.aicdn.com/ebfc4b47daaa18b27ef5104bb67f5e2864df2c541f828-YR4xae" alt=""></p>
<h4 id="android-studio-接入opencv">Android Studio 接入OpenCV</h4>
<h5 id="不含apk的sdk包">不含apk的SDK包</h5>
<p>OpenCV 2.4版本的SDK文件目录有两个版本</p>
<ul>
<li>2.4.11 包含apk文件夹<br>
apk、doc、LICENSE、README.android、samples、sdk</li>
<li>2.4.13 不包含apk文件夹<br>
doc、LICENSE、README.android、samples、sdk</li>
</ul>
<p>这几个文件的含义如下： (来源：<a href="http://docs.opencv.org/2.4/doc/tutorials/introduction/android_binary_package/O4A_SDK.html" target="_blank" rel="external">OpenCV4Android SDK</a>)</p>
<blockquote>
<p><strong>sdk</strong> folder contains OpenCV API and libraries for Android:</p>
</blockquote>
<blockquote>
<p><strong>sdk/java</strong> folder contains an Android library Eclipse project providing OpenCV Java API that can be imported into developer’s workspace;</p>
</blockquote>
<blockquote>
<p><strong>sdk/native</strong> folder contains OpenCV C++ headers (for JNI code) and native Android libraries (*.so and *.a) for ARM-v5, ARM-v7a and x86 architectures;</p>
</blockquote>
<blockquote>
<p><strong>sdk/etc</strong> folder contains Haar and LBP cascades distributed with OpenCV.</p>
</blockquote>
<blockquote>
<p><strong>apk</strong> folder contains Android packages that should be installed on the target Android device to enable OpenCV library access via OpenCV Manager API (see details below).</p>
</blockquote>
<blockquote>
<p>On production devices that have access to Google Play Market (and Internet) these packages will be installed from Market on the first start of an application using OpenCV Manager API. But devkits without Market or Internet connection require this packages to be installed manually. Install the Manager.apk and optional binary_pack.apk if it needed.
See <a href="http://docs.opencv.org/2.4/platforms/android/service/doc/UseCases.html#manager-selection" target="_blank" rel="external">How to select the proper version of OpenCV Manager</a> for details.</p>
</blockquote>
<p>OpenCV最简单的使用方式是使用manager，也就是使用apk目录下的安装包，安装对应的apk，将java层代码导入，使用OpenCVLoader.initAsync()加载库，之后你就可以直接用java代码调用Opencv相关的功能了。
似乎官方在2.4.13后不建议使用这种方式了，在2.4.13包中没有了apk文件夹。
官方文档上说，可以在Google Play上下载OpenCV manager。</p>
<ul>
<li>首先，在用户体验上来说，再下载一个apk体验是非常差的了；</li>
<li>其次，版本兼容性是个坑，用户不知道当前OpenCV版本，也不知道匹配哪个manager版本；</li>
<li>最后，Google Play在墙内看看就好，换条路对大家都好。</li>
</ul>
<p>以下完全脱离manager进行接入开发</p>
<h5 id="项目接入opencv">项目接入OpenCV</h5>
<p>（以下图片来自CSDN©_区长）</p>
<blockquote>
<p>新建一个项目，将OpenCV中sdk目录下的native目录拷到项目根目录</p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20151030233725171" alt=""></p>
<blockquote>
<p>然后新建Jni目录</p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20151030233737754" alt=""></p>
<blockquote>
<p>在里面新建两个文件：<a href="http://Android.xn--mkApplication-q59v.mk" target="_blank" rel="external">Android.mk和Application.mk</a></p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20151030233751041" alt=""></p>
<blockquote>
<p>编辑gradle.properties文件，增加下面的属性使用旧版的ndk功能（不添加会使用实验性的ndk构建工具）</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android.useDeprecatedNdk=true</div></pre></td></tr></table></figure>
<blockquote>
<p>在local.properties文件中配置ndk目录,Windows用户自行转换“/”</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ndk.dir=/(your sdk path))/ndk-bundle</div></pre></td></tr></table></figure>
<blockquote>
<p>编辑build.gradle，在android节点中增加下面的代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">sourceSets.main.jni.srcDirs = []</div><div class="line">//禁止自带的ndk功能</div><div class="line">sourceSets.main.jniLibs.srcDirs = [&apos;src/main/libs&apos;,&apos;src/main/jniLibs&apos;]</div><div class="line">//重定向so目录为src/main/libs和src/main/jniLibs，原来为src/main/jniLibs</div><div class="line"></div><div class="line">task ndkBuild(type: Exec, description: &apos;Compile JNI source with NDK&apos;) &#123;</div><div class="line">    Properties properties = new Properties()</div><div class="line">    properties.load(project.rootProject.file(&apos;local.properties&apos;).newDataInputStream())</div><div class="line">    def ndkDir = properties.getProperty(&apos;ndk.dir&apos;)</div><div class="line"></div><div class="line">    if (org.apache.tools.ant.taskdefs.condition.Os.isFamily(org.apache.tools.ant.taskdefs.condition.Os.FAMILY_WINDOWS)) &#123;</div><div class="line">        commandLine &quot;$ndkDir/ndk-build.cmd&quot;, &apos;-C&apos;, file(&apos;src/main/jni&apos;).absolutePath</div><div class="line">    &#125; else &#123;</div><div class="line">        commandLine &quot;$ndkDir/ndk-build&quot;, &apos;-C&apos;, file(&apos;src/main/jni&apos;).absolutePath</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">tasks.withType(JavaCompile) &#123;</div><div class="line">    compileTask -&gt; compileTask.dependsOn ndkBuild</div><div class="line">&#125;</div><div class="line"></div><div class="line">task ndkClean(type: Exec, description: &apos;Clean NDK Binaries&apos;) &#123;</div><div class="line">    Properties properties = new Properties()</div><div class="line">    properties.load(project.rootProject.file(&apos;local.properties&apos;).newDataInputStream())</div><div class="line">    def ndkDir = properties.getProperty(&apos;ndk.dir&apos;)</div><div class="line"></div><div class="line">    if (org.apache.tools.ant.taskdefs.condition.Os.isFamily(org.apache.tools.ant.taskdefs.condition.Os.FAMILY_WINDOWS)) &#123;</div><div class="line">        commandLine &quot;$ndkDir/ndk-build.cmd&quot;,&apos;clean&apos;, &apos;-C&apos;, file(&apos;src/main/jni&apos;).absolutePath</div><div class="line">    &#125; else &#123;</div><div class="line">        commandLine &quot;$ndkDir/ndk-build&quot;,&apos;clean&apos;, &apos;-C&apos;, file(&apos;src/main/jni&apos;).absolutePath</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">clean.dependsOn &apos;ndkClean&apos;</div></pre></td></tr></table></figure>
<blockquote>
<p>在之前新建的Application.mk中增加下面的内容</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">APP_STL := gnustl_static</div><div class="line">APP_CPPFLAGS := -frtti -fexceptions</div><div class="line">APP_ABI := armeabi armeabi-v7a</div><div class="line">APP_PLATFORM := android-8</div></pre></td></tr></table></figure>
<blockquote>
<p>在Android.mk中增加下面的内容,Windows用户自行转换“/”</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH := $(call my-dir)</div><div class="line"></div><div class="line">include $(CLEAR_VARS)</div><div class="line"></div><div class="line"></div><div class="line">OpenCV_INSTALL_MODULES := on</div><div class="line">OpenCV_CAMERA_MODULES := off</div><div class="line"></div><div class="line">OPENCV_LIB_TYPE :=STATIC</div><div class="line"></div><div class="line">ifeq (&quot;$(wildcard $(OPENCV_MK_PATH))&quot;,&quot;&quot;)</div><div class="line">include ../../../../native/jni/OpenCV.mk</div><div class="line">else</div><div class="line">include $(OPENCV_MK_PATH)</div><div class="line">endif</div><div class="line"></div><div class="line">LOCAL_MODULE := OpenCV</div><div class="line"></div><div class="line">LOCAL_SRC_FILES :=</div><div class="line"></div><div class="line">LOCAL_LDLIBS +=  -lm -llog</div><div class="line"></div><div class="line">include $(BUILD_SHARED_LIBRARY)</div></pre></td></tr></table></figure>
<p>这时候，使用gradle构建一下，如果能成功构建出so，说明配置没问题，如下图，点击as右侧的gradle展开，双击ndkBuild进行构建<br>
Gradle - your project - project(root) - Tasks - other - ndkBuild
<img src="http://img.blog.csdn.net/20151030233810853" alt=""></p>
<p>CSDN©_区长 将libopencv_java.so拷贝到jniLibs中，我实测时会报错“Error: Duplicate resources”，
意思是重复的资源。因为在Android.mk中已经引用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">include ../../../../native/jni/OpenCV.mk</div></pre></td></tr></table></figure>
<p>如果项目正常builder，就不用非得按攻略来。</p>
<h5 id="其他方案">其他方案</h5>
<p><strong>博客园©小小情意</strong>  有更方便的集成方案</p>
<ol>
<li>把sdk/java 下的项目导入到项目里，然后把这个modules 添加到 app modules里</li>
<li>build.gradle中添加compile project(’:openCVLibrary’)
或File - Project Structure - app - Dependencies中添加compile</li>
<li>在 app/src/main 目录下 创建一个jniLibs 目录，
然后把sdk/native/libs 下所有文件 拷贝到jniLibs下，编译，运行。</li>
<li>调试gradle.builde</li>
</ol>
<p>如果精通C++可以尝试动态so和静态so等集成方式</p>
<h4 id="初次使用opencv">初次使用OpenCV</h4>
<h5 id="图像灰度">图像灰度</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">OpenCVLoader.initDebug();</div><div class="line">Mat rgbMat = <span class="keyword">new</span> Mat();</div><div class="line">Mat grayMat = <span class="keyword">new</span> Mat();</div><div class="line">Bitmap srcBitmap = BitmapFactory.decodeResource(getResources(), R.drawable.ic);</div><div class="line">Bitmap grayBitmap = Bitmap.createBitmap(srcBitmap.getWidth(), srcBitmap.getHeight(), Bitmap.Config.RGB_565);</div><div class="line">Utils.bitmapToMat(srcBitmap, rgbMat);<span class="comment">//convert original bitmap to Mat, R G B.</span></div><div class="line">Imgproc.cvtColor(rgbMat, grayMat, Imgproc.COLOR_RGB2GRAY);<span class="comment">//rgbMat to gray grayMat</span></div><div class="line">Utils.matToBitmap(grayMat, grayBitmap); <span class="comment">//convert mat to bitmap</span></div><div class="line">img.setImageBitmap(grayBitmap);</div></pre></td></tr></table></figure>
<p>注意使用<strong>OpenCVLoader.initDebug();<strong>进行初始化而不是使用</strong>OpenCVLoader.initAsync()</strong><br>
文章开始已经提及initAsync是调用本地已安装的manager.apk实现功能的
另外，使用initDebug会在控制台打印以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E/OpenCV/StaticHelper: OpenCV error: Cannot load info library for OpenCV</div></pre></td></tr></table></figure>
<p>并不用管它，initDebug是打印出OpenCV运行时的详细信息。如果不想看到详情，可以使用<code>System.loadLibrary(“opencv_java”);</code>代替之。</p>
<ul>
<li><em>遇见的问题</em></li>
</ul>
<p>Utils.matToBitmap使用过程中遇到“OpenCV Error:Assertion failed”的错误。<br>
有网友提到：OpenCV中你用cvtColor(frame, current_gray, CV_RGB2GRAY);
在转彩色到灰度的时候，要求frame是3通道或者4通道。
果然换成灰度图就OK了。</p>
<h5 id="人脸识别">人脸识别</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLASSIFIER_PATH = BASE_PATH + <span class="string">"haarcascade_frontalface_alt2.xml"</span>;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">System.loadLibrary(<span class="string">"opencv_java"</span>);</div><div class="line"><span class="comment">//加载分类器</span></div><div class="line">CascadeClassifier faceDetector = <span class="keyword">new</span> CascadeClassifier(CLASSIFIER_PATH);</div><div class="line"><span class="comment">//将图像转变为java可接受的Highgui格式</span></div><div class="line">Mat image = Highgui.imread(FACE_PATH);</div><div class="line"><span class="comment">//面部框框</span></div><div class="line">MatOfRect faceDetections = <span class="keyword">new</span> MatOfRect();</div><div class="line">faceDetector.detectMultiScale(image, faceDetections);</div><div class="line"></div><div class="line">Log.d(getTag(), String.format(<span class="string">"Detected %s faces"</span>, faceDetections.toArray().length));</div><div class="line"><span class="comment">//循环找出所有的人脸</span></div><div class="line"><span class="keyword">for</span> (Rect rect : faceDetections.toArray()) &#123;</div><div class="line">    Core.rectangle(</div><div class="line">            image, <span class="keyword">new</span> Point(rect.x, rect.y),</div><div class="line">            <span class="keyword">new</span> Point(rect.x + rect.width, rect.y + rect.height),</div><div class="line">            <span class="keyword">new</span> Scalar(<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"><span class="comment">//将文件写出到指定文件</span></div><div class="line">String filename = FACE_MODIFY_PATH;</div><div class="line">Log.d(getClass().getName(), String.format(<span class="string">"Writing %s"</span>, filename));</div><div class="line"><span class="keyword">boolean</span> writeState = Highgui.imwrite(filename, image);</div><div class="line"><span class="keyword">if</span>(writeState)&#123;</div><div class="line">    Log.d(getTag(), <span class="string">"write success, path :"</span> + filename);</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">    Log.d(getTag(), <span class="string">"write failed, path :"</span> + filename);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CascadeClassifier是人脸识别的分类器，可以理解为“机器学习”的配置文件，在下载的sdk包中有路径是(your Download)/sdk/etc/haarcascades/haarcascade_frontalface_alt2.xml<br>
haar支持的目标有人脸、人眼、嘴、鼻、身体。<br>
目前提供的分类器包括Haar分类器和LBP分类器（LBP分类器数据较少）。<br>
对正面人脸分类器进行了实验，总共有4个，alt、alt2、alt_tree、default。对比下来发现alt和alt2的效果比较好，alt_tree耗时较长，default是一个轻量级的，经常出现误检测。所以还是推荐大家使用haarcascade_frontalface_atl.xml和haarcascade_frontalface_atl2.xml。<br>
（来源：<a href="http://blog.csdn.net/yang_xian521/article/details/6973667" target="_blank" rel="external">CSDN©yang_xian521</a>）</p>
<ul>
<li><em>遇见的问题</em></li>
</ul>
<p>实现过程中，Highgui.imwrite一直返回false。后来我无意间把图像换成SDCard上的图片报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">open failed: EACCES (Permission denied)</div></pre></td></tr></table></figure>
<p>才意识到时权限问题，然而相关权限都有，也是uses不是user</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:name=&quot;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&quot; /&gt;</div><div class="line">&lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot; /&gt;</div><div class="line">&lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot; /&gt;</div><div class="line">&lt;uses-permission android:name=&quot;android.permission.READ_EXTERNAL_STORAGE&quot; /&gt;</div></pre></td></tr></table></figure>
<p>关于Android 6.0权限现在还是不太懂，在build.gradle中将targetSdkVersion从26降低到21。<br>
暂时先这样。</p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/wechat-qcode-1.png" alt="Orice.Y.L.M wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎扫一扫上面的微信号</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag"># android</a>
          
            <a href="/tags/OpenCV/" rel="tag"># OpenCV</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/25/note-Atom使用/" rel="next" title="Atom使用">
                <i class="fa fa-chevron-left"></i> Atom使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/28/note-Demo中的小技巧总结/" rel="prev" title="Demo中的小技巧总结">
                Demo中的小技巧总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
       
         <div onclick="ShowGitment()" id="gitment-display-button">显示 Gitment 评论</div>
         <div id="gitment-container" style="display:none"></div>
       
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpeg"
               alt="Orice.Y.L.M" />
          <p class="site-author-name" itemprop="name">Orice.Y.L.M</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">86</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Burst Linker
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://dtysky.moe" title="dtysky" target="_blank">dtysky</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com/iissnan/hexo-theme-next" title="hexo-next" target="_blank">hexo-next</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/fsf_snail" title="CSDN&copy;蜗牛慢慢跑" target="_blank">CSDN&copy;蜗牛慢慢跑</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jianshu.com/u/64cd56319477" title="简书&copy;蜗牛慢慢跑" target="_blank">简书&copy;蜗牛慢慢跑</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://fontawesome.io/cheatsheet/" title="Cheatsheet" target="_blank">Cheatsheet</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://blankj.com/2016/07/31/android-utils-code/" title="AndroidUtilCode&copy;blankj" target="_blank">AndroidUtilCode&copy;blankj</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://xiaozhuanlan.com/cheaptalks" title="小专栏&copy;YogiAi" target="_blank">小专栏&copy;YogiAi</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com/Stay" title="stay&copy;有心课堂" target="_blank">stay&copy;有心课堂</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载sdk"><span class="nav-number">1.</span> <span class="nav-text">下载SDK</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#android-studio-接入opencv"><span class="nav-number">2.</span> <span class="nav-text">Android Studio 接入OpenCV</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#不含apk的sdk包"><span class="nav-number">2.1.</span> <span class="nav-text">不含apk的SDK包</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#项目接入opencv"><span class="nav-number">2.2.</span> <span class="nav-text">项目接入OpenCV</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#其他方案"><span class="nav-number">2.3.</span> <span class="nav-text">其他方案</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初次使用opencv"><span class="nav-number">3.</span> <span class="nav-text">初次使用OpenCV</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图像灰度"><span class="nav-number">3.1.</span> <span class="nav-text">图像灰度</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#人脸识别"><span class="nav-number">3.2.</span> <span class="nav-text">人脸识别</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Orice.Y.L.M</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






   
   
   
   
   <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
   <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
   
       <script type="text/javascript">
           function ShowGitment(){
               document.getElementById("gitment-display-button").style.display = "none";
               document.getElementById("gitment-container").style.display = "block";
               var gitment = new Gitment({
                   id: '<%= page.title %>', 
                   owner: 'yilimy',
                   repo: 'OriceComments',
                   oauth: {
                       client_id: '284d05afd92f0b10e028',
                       client_secret: '143edf1e42d35730d24bc0732b645c5f09197299',
                   }});
               gitment.render('gitment-container');
           }
       </script>
   



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("IeXcUcLh4E6UmmX4F6zPclkF-gzGzoHsz", "8dcbzKIndIphm1YLiTwzAFX6");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  


  <!-- 点击小红心 -->
  <script type="text/javascript" src="/js/src/love.js"></script>
  <!-- 背景动画 -->
  <!-- <script type="text/javascript" color="0,0,255" opacity="0.9" count="59"  src="/lib/canvas-nest/canvas-nest.min.js"></script> -->
</body>
</html>
